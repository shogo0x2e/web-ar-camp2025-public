<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <script src="https://aframe.io/releases/1.5.0/aframe.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-aframe.prod.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/three@0.160.0/build/three.min.js"></script>

    <script>
      // Prompt: 
      // キューブを中心点から放射状に飛ばして、時間経過によってキューブひとつひとつがフェードアウトしていくパーティクル
      AFRAME.registerComponent("emitter-cubes", {
        init: function () {
          const count = 200;
          const geometry = new THREE.BoxGeometry(0.05, 0.05, 0.05);

          // 頂点ごとに instanceAlpha を持たせる
          const alphaArray = new Float32Array(count);
          geometry.setAttribute("instanceAlpha", new THREE.InstancedBufferAttribute(alphaArray, 1));

          // シェーダー
          const vertexShader = `
            attribute float instanceAlpha;
            varying float vAlpha;
            void main() {
              vAlpha = instanceAlpha;
              gl_Position = projectionMatrix * modelViewMatrix * instanceMatrix * vec4(position, 1.0);
            }
          `;

          const fragmentShader = `
            varying float vAlpha;
            void main() {
              gl_FragColor = vec4(1, 0, 0, vAlpha); // 青っぽいキューブ
            }
          `;

          this.material = new THREE.ShaderMaterial({
            vertexShader,
            fragmentShader,
            transparent: true
          });

          this.mesh = new THREE.InstancedMesh(geometry, this.material, count);

          this.dummy = new THREE.Object3D();
          this.velocities = [];
          this.startTimes = [];
          this.alphas = alphaArray;

          const now = performance.now() / 1000;

          for (let i = 0; i < count; i++) {
            const dir = new THREE.Vector3(
              (Math.random() - 0.5),
              (Math.random() - 0.5),
              (Math.random() - 0.5)
            ).normalize();

            this.velocities.push(dir.multiplyScalar(0.01 + Math.random() * 0.02));
            this.startTimes.push(now + Math.random() * 2);

            this.alphas[i] = 1.0;

            this.dummy.position.set(0, 0, 0);
            this.dummy.updateMatrix();
            this.mesh.setMatrixAt(i, this.dummy.matrix);
          }

          this.el.object3D.add(this.mesh);
        },

        tick: function (time, delta) {
          const elapsed = time / 1000;
          const dummy = this.dummy;

          for (let i = 0; i < this.velocities.length; i++) {
            const t0 = this.startTimes[i];
            const life = elapsed - t0;
            if (life < 0) continue;

            const velocity = this.velocities[i];
            const dist = life * 5;

            dummy.position.set(
              velocity.x * dist,
              velocity.y * dist,
              velocity.z * dist
            );
            dummy.rotation.set(life, life * 0.5, life * 0.2);
            dummy.updateMatrix();
            this.mesh.setMatrixAt(i, dummy.matrix);

            // 粒ごとにフェードアウト
            this.alphas[i] = Math.max(1.0 - life / 1.5, 0.0);

            // 寿命が尽きたら再利用（ループ演出）
            if (this.alphas[i] <= 0.0) {
              this.startTimes[i] = elapsed + Math.random(); // 再発射
              this.alphas[i] = 1.0;
              this.mesh.setMatrixAt(i, new THREE.Matrix4()); // 原点に戻す
            }
          }

          this.mesh.instanceMatrix.needsUpdate = true;
          this.mesh.geometry.attributes.instanceAlpha.needsUpdate = true;
        }
      });
    </script>
  </head>
  <body>
    <a-scene
      mindar-image="imageTargetSrc: https://nightlife-includes-ana-protective.trycloudflare.com/shibalab_target.mind;"
      vr-mode-ui="enabled: false"
      device-orientation-permission-ui="enabled: false"
      embedded
    >
      <a-camera position="0 0 0" look-controls="enabled: false"></a-camera>

      <!-- モデルと個別フェードするキューブパーティクル -->
      <a-entity mindar-image-target="targetIndex: 0">
        <a-gltf-model 
          src="https://nightlife-includes-ana-protective.trycloudflare.com/bebeled-cube.glb" 
          position="0 0 0" 
          scale="0.1 0.1 0.1">
        </a-gltf-model>

        <a-entity emitter-cubes position="0 0 0"></a-entity>
      </a-entity>
    </a-scene>
  </body>
</html>